{% extends '_base.html' %} {# Inherit from base template #}

{% block title %}Analyze Habits - HabEx{% endblock %} {# Set page title #}

{% block content %} {# Start main content block #}
<style>
    /* Keep your existing styles here, or move them to a static CSS file */
    body {
        font-family: 'Arial', sans-serif;
        /* background-color: #fff4b2; */ /* Base template likely handles background */
        margin: 0;
        padding: 20px; /* Add some padding */
        display: flex; /* Keep flex for centering container */
        justify-content: center;
        align-items: flex-start; /* Align top */
        min-height: 90vh;
    }

    .container {
        width: 90%; /* Wider for potentially more content */
        max-width: 600px; /* Max width */
        background-color: #ffcad4; /* Pale pink form */
        border-radius: 12px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        padding: 30px;
        text-align: center;
        margin-top: 50px; /* Margin from nav */
    }

    h2 {
        margin-top: 0;
        margin-bottom: 15px; /* Added bottom margin */
        font-size: 24px;
        color: #333;
    }

     p.description { /* Style for the description paragraph */
        font-size: 16px;
        color: #555;
        margin-bottom: 25px;
    }

    select {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        margin-bottom: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 14px;
        background-color: #fff8e7; /* Light cream dropdown */
        cursor: pointer;
    }

    button, .btn-link-back { /* Style back link like a button */
        width: 100%;
        padding: 12px;
        margin-top: 15px;
        background-color: #007bff;
        color: #fff !important;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.2s ease;
        text-align: center;
        text-decoration: none !important;
        display: inline-block; /* For link styling */
        box-sizing: border-box;
    }

    button:hover, .btn-link-back:hover {
        background-color: #0056b3;
        transform: scale(1.02);
        color: #fff !important;
    }

    .result-container { /* Renamed for clarity */
        margin-top: 25px;
        padding: 20px;
        background-color: #fff8e7;
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        text-align: left; /* Align text left */
        min-height: 50px; /* Minimum height */
        font-size: 15px; /* Slightly smaller font */
    }
     .result-container h4 {
         margin-top: 0;
         color: #333;
         border-bottom: 1px solid #eee;
         padding-bottom: 8px;
         margin-bottom: 12px;
     }
     .result-container p {
         margin-bottom: 8px;
         line-height: 1.5;
     }
     .result-container em { /* Style placeholder text */
         color: #888;
     }


    .motivational-message {
        margin-top: 20px;
        font-size: 16px;
        color: #333;
        background-color: #d4edda; /* Light green for positivity */
        padding: 15px; /* Increased padding */
        border-radius: 8px;
        text-align: left; /* Align text left */
        min-height: 40px; /* Minimum height */
    }
    .motivational-message em { /* Style placeholder text */
        color: #555;
    }


    .btn-link-back { /* Style for back button link */
        background-color: #ff6f61;
        margin-top: 25px; /* More space before back button */
    }

    .btn-link-back:hover {
        background-color: #ff4f4f;
    }

    @media (max-width: 768px) {
        .container {
            width: 95%; /* Adjust width */
            padding: 20px;
        }
    }
</style>

<div class="container">
    <h2>Analyze Your Habits</h2>
    <p class="description">Select a habit below to analyze your consistency and streaks!</p>

    {# Dropdown populated dynamically from Flask #}
    <select id="habit-dropdown" name="habit_name">
        <option value="" disabled selected>-- Select a habit --</option>
        {% if habit_names %}
            {% for name in habit_names %}
                <option value="{{ name }}">{{ name }}</option>
            {% endfor %}
        {% else %}
            <option value="" disabled>No habits logged yet</option>
        {% endif %}
    </select>

    {# Button to trigger JavaScript analysis #}
    <button onclick="analyzeHabit()">Analyze Habit</button>

    {# Div to display analysis results #}
    <div class="result-container" id="streak-chart">
        üìä <em>Select a habit and click "Analyze" to see your stats.</em>
    </div>

    {# Div for motivational messages (could be updated based on results) #}
    <div class="motivational-message" id="message-box">
        üåü <em>Keep building those habits!</em>
    </div>

    {# Back button as a styled link using url_for #}
    <a href="{{ url_for('dashboard') }}" class="btn-link-back">Go Back to Dashboard</a>
</div>

<script>
    // No longer need DOMContentLoaded to populate dropdown - Jinja handles it.

    async function analyzeHabit() { // Use async/await for cleaner fetch
        const habitDropdown = document.getElementById('habit-dropdown');
        const habitName = habitDropdown.value;
        const resultsDiv = document.getElementById('streak-chart');
        const messageBox = document.getElementById('message-box');

        // Clear previous results
        resultsDiv.innerHTML = '<em>Loading analysis...</em>';
        messageBox.innerHTML = '<em>Checking your progress...</em>';

        if (!habitName) {
            resultsDiv.innerHTML = '<em>Please select a habit first!</em>';
            messageBox.innerHTML = ''; // Clear message box
            return;
        }

        try {
            // Fetch analysis data from the Flask endpoint
            const response = await fetch(`/get_habit_analysis/${encodeURIComponent(habitName)}`);

            if (!response.ok) {
                 // Handle non-JSON errors from server (like 404, 500)
                const errorText = await response.text(); // Try get text feedback
                throw new Error(`Network response error: ${response.status} ${response.statusText}. ${errorText}`);
            }

            const data = await response.json();

            if (data.error) {
                // Handle errors returned in JSON from Flask
                resultsDiv.innerHTML = `<em>Error: ${data.error}</em>`;
                messageBox.innerHTML = 'ü§î <em>Try logging this habit first.</em>';
            } else {
                // Update the HTML with fetched data
                resultsDiv.innerHTML = `
                    <h4>Analysis for: ${data.habit_name}</h4>
                    <p><strong>Total Logs Found:</strong> ${data.total_logs}</p>
                    <p><strong>Completed Logs:</strong> ${data.completed_logs}</p>
                    <p><strong>Overall Consistency:</strong> ${data.consistency_percent}%</p>
                `;
                // Update motivational message based on streaks
                let message = `Current Streak: ${data.current_streak} days | Longest Streak: ${data.max_streak} days. `;
                if (data.current_streak > 3) {
                    message += "üî• Keep the fire burning!";
                } else if (data.max_streak > 0) {
                    message += "üëç You've done it before, you can do it again!";
                } else {
                    message += "üå± Every journey starts with a single step.";
                }
                 messageBox.innerHTML = `üåü ${message}`;
            }
        } catch (error) {
            console.error('Fetch error:', error);
            resultsDiv.innerHTML = `<em>Could not load analysis. ${error.message}</em>`;
            messageBox.innerHTML = 'üòû <em>Something went wrong. Please try again later.</em>';
        }
    }

    // Remove the old goBack() function if it exists, use the <a> tag instead
    // function goBack() { ... } // DELETE THIS

</script>

{% endblock %} {# End content block #}